---
phase: 03-transactions-and-balances
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/transactions/TransactionTable.tsx
  - src/components/transactions/TransactionRow.tsx
  - src/components/transactions/Pagination.tsx
  - src/components/transactions/TransactionFilters.tsx
  - src/components/transactions/BalanceSummary.tsx
  - src/pages/TransactionsPage.tsx
  - src/App.tsx
autonomous: true
requirements:
  - TXN-05
  - TXN-06
  - TXN-07
  - TXN-08
  - BAL-02

must_haves:
  truths:
    - "User can see transactions in a paginated table with page numbers and prev/next controls"
    - "User can filter transactions by date range, type, category, account, and min/max amount via collapsible filter bar"
    - "User can search transactions by description with live debounced results"
    - "User can sort the transaction table by clicking column headers"
    - "Balance summary header shows per-account balances in native currencies plus consolidated total in base currency"
    - "/transactions route is accessible and renders the transactions page"
    - "Clicking an account navigates to /transactions?account=:id with filter pre-applied"
    - "Nueva Transaccion button is always visible in the page header"
  artifacts:
    - path: "src/components/transactions/TransactionTable.tsx"
      provides: "Table with sortable column headers and transaction rows"
      contains: "export const TransactionTable"
    - path: "src/components/transactions/TransactionRow.tsx"
      provides: "Single transaction row with green/red amount coloring"
      contains: "export const TransactionRow"
    - path: "src/components/transactions/Pagination.tsx"
      provides: "Page-number pagination with prev/next controls"
      contains: "export const Pagination"
    - path: "src/components/transactions/TransactionFilters.tsx"
      provides: "Collapsible filter bar with all filter controls"
      contains: "export const TransactionFilters"
    - path: "src/components/transactions/BalanceSummary.tsx"
      provides: "Balance summary header with per-account + consolidated total"
      contains: "export const BalanceSummary"
    - path: "src/pages/TransactionsPage.tsx"
      provides: "Page orchestrator wiring all transaction components"
      contains: "export const TransactionsPage"
      min_lines: 100
    - path: "src/App.tsx"
      provides: "Updated routes with /transactions"
      contains: 'path="/transactions"'
  key_links:
    - from: "src/pages/TransactionsPage.tsx"
      to: "src/stores/transactionStore.ts"
      via: "useTransactionStore for data + filters + CRUD"
      pattern: "useTransactionStore"
    - from: "src/components/transactions/TransactionFilters.tsx"
      to: "src/stores/transactionStore.ts"
      via: "setFilters for filter changes"
      pattern: "setFilters"
    - from: "src/components/transactions/Pagination.tsx"
      to: "src/stores/transactionStore.ts"
      via: "setPage for page navigation"
      pattern: "setPage"
    - from: "src/components/transactions/TransactionTable.tsx"
      to: "src/stores/transactionStore.ts"
      via: "setFilters for sort column/direction changes"
      pattern: "setFilters.*sortBy"
    - from: "src/components/transactions/BalanceSummary.tsx"
      to: "src/lib/tauri.ts"
      via: "transactionApi.getBalanceSummary"
      pattern: "transactionApi\\.getBalanceSummary"
    - from: "src/App.tsx"
      to: "src/pages/TransactionsPage.tsx"
      via: "Route element"
      pattern: "TransactionsPage"
---

<objective>
Build the complete transactions page UI: sortable paginated table, collapsible filter bar, live debounced search, balance summary header, and route wiring with per-account navigation.

Purpose: Deliver the user-facing transaction list experience with all viewing, filtering, sorting, and navigation capabilities.
Output: TransactionsPage with TransactionTable, TransactionRow, Pagination, TransactionFilters, BalanceSummary components. Route wired in App.tsx. Account→transactions navigation.
</objective>

<execution_context>
@/home/jacket/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/jacket/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transactions-and-balances/03-RESEARCH.md
@.planning/phases/03-transactions-and-balances/03-01-SUMMARY.md
@.planning/phases/03-transactions-and-balances/03-02-SUMMARY.md

<interfaces>
<!-- Store and API from Plans 01-02 — executor should read actual files -->

From src/stores/transactionStore.ts (created by Plan 02):

```typescript
interface TransactionState {
  transactions: Transaction[];
  total: number;
  totalPages: number;
  isLoading: boolean;
  error: string | null;
  filters: {
    accountId: string | null;
    categoryId: string | null;
    transactionType: TransactionType | null;
    dateFrom: string | null;
    dateTo: string | null;
    amountMin: number | null;
    amountMax: number | null;
    search: string;
    sortBy: string;
    sortDir: "ASC" | "DESC";
    page: number;
    pageSize: number;
  };
  fetchTransactions: () => Promise<void>;
  setFilters: (updates: Partial<...>) => void;
  setPage: (page: number) => void;
  createTransaction: (input: CreateTransactionInput) => Promise<Transaction>;
  updateTransaction: (id: string, input: UpdateTransactionInput) => Promise<Transaction>;
  deleteTransaction: (id: string) => Promise<void>;
  resetFilters: () => void;
}
export const useTransactionStore = create<TransactionState>(...);
```

From src/lib/tauri.ts (created by Plan 01):

```typescript
export const transactionApi = {
  list: (filters: TransactionFilters): Promise<PaginatedResult<Transaction>> => ...,
  getBalanceSummary: (baseCurrencyId?: string): Promise<BalanceSummary> => ...,
};
```

From src/lib/hooks.ts (created by Plan 01):

```typescript
export const useDebounce = <T>(value: T, delay?: number): T => ...;
```

From src/lib/formatters.ts (existing + Plan 01 additions):

```typescript
export const formatCurrency = (minorUnits: number, currencyCode: string): string => ...;
export const fromMinorUnits = (minorUnits: number, decimalPlaces: number): number => ...;
```

From src/types/index.ts (existing):

```typescript
export interface Account { id: string; name: string; type: AccountType; currencyId: string; balance: number; ... }
export interface Category { id: string; name: string; type: CategoryType; ... }
export interface Transaction { id: string; accountId: string; categoryId: string; amount: number; type: TransactionType; description: string; date: string; ... }
export interface BalanceSummary { accounts: AccountBalance[]; consolidatedTotal: number | null; baseCurrencyCode: string; }
```

From src/App.tsx (existing routes):

```typescript
<Routes>
  <Route path="/" element={<Navigate to="/accounts" replace />} />
  <Route path="/accounts" element={<AccountsPage />} />
  <Route path="/accounts/new" element={<NewAccountPage />} />
  <Route path="/accounts/:id/edit" element={<EditAccountPage />} />
  <Route path="/categories" element={<CategoriesPage />} />
</Routes>
```

From src/pages/CategoriesPage.tsx (existing page pattern):

- useEffect to fetchCategories on mount
- Loading/error/empty states
- Toast notification with auto-dismiss
- Modal state management (formModal, deleteModal)
- Context menu for right-click actions
  </interfaces>
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Transaction table, row, pagination, and filter components</name>
  <files>
    src/components/transactions/TransactionTable.tsx
    src/components/transactions/TransactionRow.tsx
    src/components/transactions/Pagination.tsx
    src/components/transactions/TransactionFilters.tsx
  </files>
  <action>
    **TransactionTable.tsx:**
    - Props: `transactions: Transaction[]`, `sortBy: string`, `sortDir: "ASC" | "DESC"`, `onSort: (column: string) => void`, `onEdit: (txn: Transaction) => void`, `onDelete: (txn: Transaction) => void`, `accounts: Account[]`, `categories: Category[]`.
    - Renders a `<table>` with columns: Fecha, Descripcion, Categoria, Cuenta, Monto. Use theme styling consistent with the project (`#0a0f06` backgrounds, `#c4d4a0` text, `#2a3518` borders).
    - **Sortable headers:** Each column header is clickable. On click, call `onSort(columnName)`. Show sort direction indicator using Lucide icons: `ArrowUp` for ASC, `ArrowDown` for DESC, only on the active sort column. Inactive sortable columns show a subtle `ArrowUpDown` icon.
    - Column mapping to sort keys: Fecha→"date", Descripcion→"description", Monto→"amount", Categoria and Cuenta are display-only (not sortable).
    - Default sort: "date" DESC.
    - Table header style: `backgroundColor: "#111a0a"`, `color: "#6b7c3e"`, sticky if possible.
    - Map over transactions rendering `<TransactionRow>` for each.
    - Empty state: "No se encontraron transacciones" centered text when list is empty and not loading.

    **TransactionRow.tsx:**
    - Props: `transaction: Transaction`, `account: Account | undefined`, `category: Category | undefined`, `onEdit: (txn: Transaction) => void`, `onDelete: (txn: Transaction) => void`.
    - Renders a `<tr>` with: date (formatted as locale string), description (or "—" if empty), category name (from prop), account name (from prop), amount.
    - **Amount coloring per user decision:** Green (`#7fff00`) for income, red (`#ff4444`) for expense. Prefix income with "+" and expense with "-". Format using `formatCurrency(txn.amount, currencyCode)` where currencyCode is derived from the account's currencyId.
    - Row hover: subtle background change (`#111a0a` → `#1a2510`).
    - Right-click context menu OR click actions for edit/delete. Use simple click handlers — the TransactionsPage will manage modal state. Consider a small action button column with edit/delete icons (Pencil, Trash2 from lucide-react).

    **Pagination.tsx:**
    - Props: `page: number`, `totalPages: number`, `onPageChange: (page: number) => void`.
    - Renders: "Anterior" button (disabled on page 1), page number buttons, "Siguiente" button (disabled on last page).
    - Page numbers: Show up to 5 page numbers centered around current page. If total > 5, show ellipsis (...) for skipped ranges. Always show first and last page.
    - Active page: highlighted with `#7fff00` text and bottom border. Other pages: `#6b7c3e` text.
    - Style: flex row, centered, gap between buttons, monospace font.

    **TransactionFilters.tsx:**
    - Props: `filters: TransactionState["filters"]`, `onFilterChange: (updates: Partial<...>) => void`, `onReset: () => void`, `accounts: Account[]`, `categories: Category[]`.
    - **Collapsible design per user decision:** A toggle button "Filtros" with a chevron icon (ChevronDown/ChevronUp from lucide-react). Click toggles `isExpanded` state.
    - **Search bar:** Always visible (above the collapsible section). `<input type="text">` with placeholder "Buscar por descripcion...". Value bound to a local state, debounced with `useDebounce(searchValue, 300)`. When debounced value changes, call `onFilterChange({ search: debouncedSearch })`. Use `useEffect` to watch debounced value.
    - **Filter controls (inside collapsible):**
      - Date range: Two `<input type="date">` fields side by side — "Desde" and "Hasta".
      - Type: Dropdown `<select>` with options: "Todos", "Ingreso", "Gasto".
      - Category: Dropdown `<select>` populated from categories prop. Group by parent/subcategory. "Todas" as default.
      - Account: Dropdown `<select>` populated from accounts prop. "Todas" as default.
      - Amount range: Two number inputs — "Min" and "Max" (in human-readable format — these will be converted to minor units by the page before passing to store).
    - **Reset button:** "Limpiar filtros" — calls `onReset()`.
    - All filter inputs use the same inputStyle as CategoryFormModal (`#111a0a` bg, `#2a3518` border, `#c4d4a0` text).
    - Filter controls arranged in a responsive grid (2-3 columns on desktop).

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>TransactionTable renders sortable column headers with direction indicators. TransactionRow shows green/red amount coloring. Pagination shows page numbers with prev/next and ellipsis. TransactionFilters has always-visible search with debounce and collapsible filter controls for all 6 filter types.</done>
</task>

<task type="auto">
  <name>Task 2: Balance summary, transactions page orchestration, and route wiring</name>
  <files>
    src/components/transactions/BalanceSummary.tsx
    src/pages/TransactionsPage.tsx
    src/App.tsx
  </files>
  <action>
    **BalanceSummary.tsx:**
    - Fetches balance data using `transactionApi.getBalanceSummary()` on mount and after transaction mutations (accept a `refreshKey: number` prop that increments after mutations to trigger refetch).
    - Displays a horizontal summary bar in the page header:
      - Per-account balances: Each account shown as "AccountName: $Amount" in the account's native currency using `formatCurrency`.
      - Consolidated total: "Total: $Amount" in base currency (e.g., CLP). Show in a larger/bolder font.
      - If `consolidatedTotal` is null (no exchange rates available), show "Total: —" with a tooltip or small note "Tipo de cambio no disponible".
    - **Balance flash animation per user decision:** When balance values change, apply a CSS animation class `balance-updated` that triggers a brief green glow/flash. Implementation: track previous values in a ref, compare with new values, if changed apply the class, remove after animation completes (onAnimationEnd). CSS animation: `@keyframes balance-flash { 0% { color: #7fff00; text-shadow: 0 0 8px rgba(127,255,0,0.6); } 100% { color: #c4d4a0; text-shadow: none; } }` with `animation: balance-flash 0.8s ease-out`.
    - Layout: Flex row with gap, items centered. Accounts in smaller text, total in larger text. Wrap on smaller screens.

    **TransactionsPage.tsx:**
    - Follow CategoriesPage pattern for structure (header, content area, modals, toast).
    - **On mount:** Call `fetchTransactions()` from store. Also `fetchAccounts()` from accountStore and `fetchCategories()` from categoryStore (needed for dropdowns and display names).
    - **URL query param support per user decision:** Use `useSearchParams` from react-router. On mount, read `account` query param. If present, call `setFilters({ accountId: accountParam })`. This enables clicking an account in accounts list to navigate to `/transactions?account=:id`.
    - **Header:** Title "Transacciones" (same h1 style as CategoriesPage). "Nueva Transaccion" button — always visible, primary action, prominent green button matching CategoriesPage "+" button style.
    - **Page layout (top to bottom):**
      1. Header (title + button)
      2. BalanceSummary (per-account + consolidated)
      3. TransactionFilters (search always visible, filters collapsible)
      4. TransactionTable (sortable columns)
      5. Pagination (below table)
    - **Sort handler:** When column header clicked, toggle: if same column, flip direction; if different column, set new column with DESC default. Call `setFilters({ sortBy, sortDir })`.
    - **Filter handler:** Pass `setFilters` to TransactionFilters. For amount min/max, convert from human-readable to minor units using `toMinorUnits` before passing to store (need account's currency context — use base currency CLP as default for amount filter conversion, since filters are cross-account).
    - **Modal state:** Same pattern as CategoriesPage — `formModal: { isOpen, editTransaction? }`, `deleteModal: { isOpen, transaction }`.
    - **Edit/delete wiring:** TransactionRow edit → opens formModal with editTransaction. TransactionRow delete → opens deleteModal. Form/delete modal onSuccess → show toast, increment balanceSummary refreshKey, refetch.
    - **Refetch after mutations:** Store automatically refetches in CRUD actions. BalanceSummary needs explicit refetch trigger via refreshKey.
    - **Loading state:** Show "Cargando transacciones..." when isLoading.
    - **Error state:** Show error div matching CategoriesPage error styling.
    - **Toast:** Same auto-dismiss pattern (3s) as CategoriesPage.

    **App.tsx:**
    - Import `TransactionsPage`.
    - Add route: `<Route path="/transactions" element={<TransactionsPage />} />` after the categories route.
    - Add a simple navigation link for "Transacciones" in the sidebar/nav. Since there's no full sidebar yet (Phase 8), add a minimal nav bar at the top of the app layout (if one doesn't exist) or a simple link list. Check existing nav patterns — if accounts/categories pages have any navigation, follow that pattern. If no nav exists, add a minimal horizontal nav bar above the Routes with links to: Cuentas (/accounts), Categorias (/categories), Transacciones (/transactions). Style with theme colors.
    - Also wire account → transactions navigation: In the accounts page or account list, when clicking an account or a "Ver transacciones" action, navigate to `/transactions?account=${account.id}`. This may require a small update to the accounts page or AccountRow component — check what exists and add a navigation link/button. If this is too invasive for this plan (touching account components), defer to a minimal approach: just ensure the route works with `?account=:id` query param. The AccountsPage can be updated minimally.

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>/transactions route renders TransactionsPage. Page shows balance summary header, search bar, collapsible filters, sortable paginated table, and modals for create/edit/delete. Balance numbers flash on mutation. URL ?account=:id pre-applies account filter. Navigation includes Transacciones link. Nueva Transaccion button always visible in header.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — All TypeScript compiles
2. Navigate to /transactions — page renders with empty state
3. Create a transaction via form — it appears in table with correct amount coloring
4. Filter by account — only that account's transactions show
5. Search by description — results update after typing stops
6. Sort by date/amount — table reorders with direction indicator
7. Pagination controls appear when more than 20 transactions
8. Balance summary shows per-account balances and consolidated total
9. Balance numbers flash green briefly after creating/editing/deleting a transaction
10. /transactions?account=:id pre-filters by account
</verification>

<success_criteria>

- Paginated transaction table with prev/next and page numbers (TXN-05)
- Collapsible filter bar with date range, type, category, account, amount filters (TXN-06)
- Live debounced text search by description (TXN-07)
- Sortable columns with direction indicators (TXN-08)
- Balance summary with per-account + consolidated total in base currency (BAL-02)
- Balance flash animation on mutation (user decision)
- /transactions route with ?account=:id query param support
- "Nueva Transaccion" button always visible in header
- Navigation entry for Transacciones
  </success_criteria>

<output>
After completion, create `.planning/phases/03-transactions-and-balances/03-03-SUMMARY.md`
</output>
