---
phase: 03-transactions-and-balances
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/stores/transactionStore.ts
  - src/components/transactions/TransactionFormModal.tsx
  - src/components/transactions/DeleteTransactionModal.tsx
autonomous: true
requirements:
  - TXN-01
  - TXN-02
  - TXN-03
  - TXN-04

must_haves:
  truths:
    - "Store can fetch filtered/paginated transactions from backend and expose loading/error state"
    - "Store resets page to 1 when any filter (other than page itself) changes"
    - "Transaction form opens with current date preselected in create mode"
    - "User can toggle between income and expense type via prominent segmented buttons"
    - "Amount is converted from human-readable decimal to minor units before calling backend"
    - "Delete modal shows confirmation prompt and handles backend errors with 'Entendido' button"
  artifacts:
    - path: "src/stores/transactionStore.ts"
      provides: "Zustand store with filter/pagination/sort state and CRUD actions"
      contains: "export const useTransactionStore"
      min_lines: 80
    - path: "src/components/transactions/TransactionFormModal.tsx"
      provides: "Modal form for create/edit transactions with toggle, amount conversion, date preselect"
      contains: "export const TransactionFormModal"
      min_lines: 150
    - path: "src/components/transactions/DeleteTransactionModal.tsx"
      provides: "Confirmation modal for transaction deletion"
      contains: "export const DeleteTransactionModal"
      min_lines: 50
  key_links:
    - from: "src/stores/transactionStore.ts"
      to: "src/lib/tauri.ts"
      via: "transactionApi CRUD calls"
      pattern: "transactionApi\\."
    - from: "src/components/transactions/TransactionFormModal.tsx"
      to: "src/stores/transactionStore.ts"
      via: "createTransaction/updateTransaction store actions"
      pattern: "useTransactionStore"
    - from: "src/components/transactions/TransactionFormModal.tsx"
      to: "src/lib/formatters.ts"
      via: "toMinorUnits for amount conversion before save"
      pattern: "toMinorUnits"
    - from: "src/components/transactions/DeleteTransactionModal.tsx"
      to: "src/stores/transactionStore.ts"
      via: "deleteTransaction store action"
      pattern: "useTransactionStore"
---

<objective>
Build the transaction Zustand store with filter/pagination/sort state and CRUD modals (create/edit form + delete confirmation).

Purpose: Provide state management and user-facing CRUD interfaces for transactions. The store manages all query parameters and data fetching. The form modal handles create/edit with type toggle, amount conversion, and date preselection. The delete modal follows the established pattern.
Output: transactionStore.ts, TransactionFormModal.tsx, DeleteTransactionModal.tsx
</objective>

<execution_context>
@/home/jacket/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/jacket/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transactions-and-balances/03-RESEARCH.md
@.planning/phases/03-transactions-and-balances/03-01-SUMMARY.md

<interfaces>
<!-- Types and APIs created by Plan 01 — executor should read actual files -->

From src/types/index.ts (added by Plan 01):

```typescript
export type TransactionType = "income" | "expense";

export interface Transaction {
  id: string;
  accountId: string;
  categoryId: string;
  amount: number;
  type: TransactionType;
  description: string;
  date: string;
  notes: string | null;
  createdAt: string;
}

export interface CreateTransactionInput {
  accountId: string;
  categoryId: string;
  amount: number; // minor units
  transactionType: TransactionType;
  description: string;
  date: string;
}

export interface UpdateTransactionInput {
  accountId?: string;
  categoryId?: string;
  amount?: number;
  transactionType?: TransactionType;
  description?: string;
  date?: string;
}

export interface TransactionFilters {
  accountId?: string | null;
  categoryId?: string | null;
  transactionType?: string | null;
  dateFrom?: string | null;
  dateTo?: string | null;
  amountMin?: number | null;
  amountMax?: number | null;
  search?: string | null;
  sortBy?: string | null;
  sortDir?: "ASC" | "DESC" | null;
  page?: number | null;
  pageSize?: number | null;
}

export interface PaginatedResult<T> {
  data: T[];
  total: number;
  page: number;
  pageSize: number;
  totalPages: number;
}
```

From src/lib/tauri.ts (added by Plan 01):

```typescript
export const transactionApi = {
  list: (filters: TransactionFilters): Promise<PaginatedResult<Transaction>> => ...,
  create: (input: CreateTransactionInput): Promise<Transaction> => ...,
  update: (id: string, input: UpdateTransactionInput): Promise<Transaction> => ...,
  delete: (id: string): Promise<void> => ...,
  getBalanceSummary: (baseCurrencyId?: string): Promise<BalanceSummary> => ...,
};
```

From src/lib/formatters.ts (added by Plan 01):

```typescript
export const toMinorUnits = (amount: number, decimalPlaces: number): number => ...;
export const fromMinorUnits = (minorUnits: number, decimalPlaces: number): number => ...;
```

From src/stores/categoryStore.ts (existing pattern):

```typescript
export const useCategoryStore = create<CategoryState>((set, get) => ({
  categories: [],
  isLoading: false,
  error: null,
  fetchCategories: async () => {
    set({ isLoading: true, error: null });
    try {
      const categories = await categoryApi.list();
      set({ categories, isLoading: false });
    } catch (e) {
      set({ error: String(e), isLoading: false });
    }
  },
  addCategory: async (input) => {
    try {
      const result = await categoryApi.create(input);
      set((state) => ({ categories: [...state.categories, result] }));
      return result;
    } catch (e) {
      await get().fetchCategories();
      throw e;
    }
  },
  // ...
}));
```

From src/components/categories/CategoryFormModal.tsx (existing modal form pattern):

- Uses useForm from react-hook-form with zodResolver
- mode: "onBlur"
- useEffect to reset form when modal opens with new data
- isDirty guard on close with window.confirm
- formError state for backend errors
- Overlay + centered modal + close button + form + actions pattern
- Style constants: fontMono, labelStyle, inputStyle with the Lovecraftian theme colors
  </interfaces>
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand transaction store with filter/pagination/sort state</name>
  <files>src/stores/transactionStore.ts</files>
  <action>
    Create the Zustand store following the categoryStore pattern but extended with filter/pagination/sort state. The store manages both the data AND the query parameters.

    **State shape:**
    ```typescript
    interface TransactionState {
      // Data
      transactions: Transaction[];
      total: number;
      totalPages: number;
      isLoading: boolean;
      error: string | null;

      // Filter/pagination/sort state (these drive the backend query)
      filters: {
        accountId: string | null;
        categoryId: string | null;
        transactionType: TransactionType | null;
        dateFrom: string | null;
        dateTo: string | null;
        amountMin: number | null;
        amountMax: number | null;
        search: string;
        sortBy: string;
        sortDir: "ASC" | "DESC";
        page: number;
        pageSize: number;
      };

      // Actions
      fetchTransactions: () => Promise<void>;
      setFilters: (updates: Partial<TransactionState["filters"]>) => void;
      setPage: (page: number) => void;
      createTransaction: (input: CreateTransactionInput) => Promise<Transaction>;
      updateTransaction: (id: string, input: UpdateTransactionInput) => Promise<Transaction>;
      deleteTransaction: (id: string) => Promise<void>;
      resetFilters: () => void;
    }
    ```

    **Default filter values:** `accountId: null`, `categoryId: null`, `transactionType: null`, `dateFrom: null`, `dateTo: null`, `amountMin: null`, `amountMax: null`, `search: ""`, `sortBy: "date"`, `sortDir: "DESC"`, `page: 1`, `pageSize: 20`.

    **fetchTransactions:** Build a `TransactionFilters` object from current `filters` state, call `transactionApi.list(filters)`, set transactions/total/totalPages from result. Handle loading/error states like categoryStore.

    **setFilters(updates):** Merge updates into current filters. CRITICAL: if any filter OTHER than `page` changes, reset `page` to 1. This prevents the empty-page bug when filters reduce result count. Implementation: `set((state) => ({ filters: { ...state.filters, ...updates, page: 'page' in updates ? updates.page : 1 } }))` — but more carefully: only reset page if updates contains something other than just `page`.

    **setPage(page):** Shorthand: `set((state) => ({ filters: { ...state.filters, page } }))`.

    **createTransaction:** Call `transactionApi.create(input)`, then `await get().fetchTransactions()` to reload the list (since pagination/totals may change). Return the created transaction.

    **updateTransaction:** Call `transactionApi.update(id, input)`, then `await get().fetchTransactions()`. Return the updated transaction.

    **deleteTransaction:** Call `transactionApi.delete(id)`, then `await get().fetchTransactions()`.

    **resetFilters:** Reset all filters to defaults.

    NOTE: Unlike category/account stores which do optimistic updates, the transaction store does a full refetch after mutations because pagination totals and filtered results need recalculation.

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>transactionStore exports useTransactionStore. Store has filter/pagination/sort state with defaults. setFilters resets page to 1 on non-page changes. CRUD actions refetch after mutation. fetchTransactions calls transactionApi.list with current filters.</done>
</task>

<task type="auto">
  <name>Task 2: Transaction form modal and delete modal</name>
  <files>
    src/components/transactions/TransactionFormModal.tsx
    src/components/transactions/DeleteTransactionModal.tsx
  </files>
  <action>
    **Create src/components/transactions/ directory** (mkdir if needed).

    **TransactionFormModal.tsx** — Follow CategoryFormModal pattern closely for structure, styling, and dirty-state handling. Key differences:

    1. **Props:** `isOpen`, `onClose`, `onSuccess: (message: string) => void`, `editTransaction?: Transaction` (optional, if provided = edit mode).

    2. **Zod schema:**
       ```typescript
       const transactionSchema = z.object({
         transactionType: z.enum(["income", "expense"], { message: "Selecciona un tipo" }),
         amount: z.string().min(1, "El monto es requerido").refine(
           (val) => { const n = parseFloat(val); return !isNaN(n) && n > 0; },
           { message: "El monto debe ser mayor a 0" }
         ),
         accountId: z.string().min(1, "Selecciona una cuenta"),
         categoryId: z.string().min(1, "Selecciona una categoria"),
         date: z.string().min(1, "La fecha es requerida"),
         description: z.string().default(""),
       });
       ```

    3. **Field order (per user decision):** Type toggle > Amount > Account > Category > Date > Description.

    4. **Type toggle:** Two buttons side by side (segmented control feel). Selected button: `backgroundColor: "#4a5d23"`, `color: "#7fff00"`, `border: 1px solid #7fff00`. Unselected button: `backgroundColor: "#111a0a"`, `color: "#6b7c3e"`, `border: 1px solid #2a3518`. Use Controller from react-hook-form for the toggle (not native radio buttons — user wants "prominent toggle buttons", not radios).

    5. **Amount field:** `<input type="text" inputMode="decimal">`. User types human-readable value ("15000" for CLP, "29.99" for USD). Store as string in form state. Convert to minor units on submit using `toMinorUnits(parseFloat(amount), decimalPlaces)` where `decimalPlaces` comes from the selected account's currency.

    6. **Account dropdown:** Load accounts from `useAccountStore` (import accountStore). Show active accounts. When account changes, filter categories if needed. Display account name + currency code.

    7. **Category dropdown:** Load categories from `useCategoryStore`. Filter by selected transactionType (show only income categories for income, expense categories for expense). Show parent > subcategory hierarchy in option labels.

    8. **Date field:** `<input type="date">`. Default value in create mode: `new Date().toISOString().split('T')[0]` (TXN-04). In edit mode: existing transaction date.

    9. **Description field:** Optional free text. `<input type="text">` or `<textarea>`. Default to empty string.

    10. **In edit mode:** Pre-populate all fields from `editTransaction`. Amount displayed as human-readable (use `fromMinorUnits` to convert back for display). Need to know the account's currency to do the conversion — look up account from accountStore.

    11. **onSubmit:** Convert amount to minor units. Call `transactionStore.createTransaction(input)` or `transactionStore.updateTransaction(id, input)`. On success: `onSuccess("Transaccion creada/actualizada")`. On error: `setFormError(String(e))`.

    12. **Dirty state guard:** Same `window.confirm("Descartar cambios?")` pattern as CategoryFormModal.

    **DeleteTransactionModal.tsx** — Follow DeleteCategoryModal pattern exactly:

    1. **Props:** `isOpen`, `transaction: Transaction | null`, `onClose`, `onSuccess: (message: string) => void`.

    2. **Content:** "Estas seguro de que quieres eliminar esta transaccion?" Show transaction details: amount (formatted with `formatCurrency`), date, description.

    3. **Actions:** "Eliminar" (red) + "Cancelar". On error: show error + "Entendido" button (same pattern as DeleteCategoryModal).

    4. **Call:** `transactionStore.deleteTransaction(transaction.id)`.

    **Styling:** Use the same theme constants (fontMono, labelStyle, inputStyle, modal colors) as CategoryFormModal. `#0a0f06` modal background, `#4a5d23` border, `#c4d4a0` text, `#6b7c3e` labels, `#111a0a` input background.

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>TransactionFormModal renders create/edit modes with type toggle buttons, amount in human-readable format, account/category dropdowns, date preselected to today, optional description. Amount converts to minor units on submit. DeleteTransactionModal follows category delete pattern with error→Entendido flow. Both modals compile and follow established styling patterns.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — All TypeScript compiles
2. Verify transactionStore has setFilters that resets page on filter change
3. Verify TransactionFormModal uses toMinorUnits before calling create/update
4. Verify date field defaults to today's date in create mode
5. Verify type toggle uses prominent buttons (not radio inputs)
</verification>

<success_criteria>

- Transaction store manages filter/pagination/sort state with page-reset-on-filter-change logic
- Create mode preselects current date (TXN-04)
- Type selection uses prominent toggle buttons per user decision
- Amount conversion uses toMinorUnits/fromMinorUnits correctly per account currency
- Delete modal shows confirmation and handles errors with 'Entendido' button
- All components follow established Lovecraftian theme styling
  </success_criteria>

<output>
After completion, create `.planning/phases/03-transactions-and-balances/03-02-SUMMARY.md`
</output>
