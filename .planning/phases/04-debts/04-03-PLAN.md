---
phase: 04-debts
plan: 03
type: execute
wave: 2
depends_on: [01]
files_modified:
  - src/pages/DebtsPage.tsx
  - src/components/debts/DebtCard.tsx
  - src/components/debts/DebtDetail.tsx
  - src/components/debts/InstallmentRow.tsx
  - src/components/debts/CreditUtilization.tsx
  - src/components/debts/ProjectionTable.tsx
  - src/App.tsx
autonomous: false
requirements:
  - DEBT-02
  - DEBT-04
  - DEBT-05
  - DEBT-06
  - DEBT-07

must_haves:
  truths:
    - "User can see a list of debts as expandable cards showing description, account, progress bar, remaining amount, monthly payment, interest rate, and next due date"
    - "User can expand a debt card to see all installments with status badges (pagado/pendiente/vencido)"
    - "Overdue installments (due_date < today AND status pending) display vencido badge automatically"
    - "User can see credit utilization for credit-card accounts showing current balance, remaining commitments, credit limit, and available credit"
    - "User can see a 6-month projection table with per-debt columns and monthly total"
    - "Navigation bar includes Deudas link and route is wired in App.tsx"
  artifacts:
    - path: "src/pages/DebtsPage.tsx"
      provides: "Main debts page composing all debt components"
      contains: "DebtsPage"
    - path: "src/components/debts/DebtCard.tsx"
      provides: "Expandable accordion card with collapsed summary and expanded detail"
      contains: "DebtCard"
    - path: "src/components/debts/DebtDetail.tsx"
      provides: "Expanded view with installment list, progress bar, mark-as-paid buttons"
      contains: "DebtDetail"
    - path: "src/components/debts/InstallmentRow.tsx"
      provides: "Single installment row with status badge and mark-paid action"
      contains: "InstallmentRow"
    - path: "src/components/debts/CreditUtilization.tsx"
      provides: "Credit card utilization summary section"
      contains: "CreditUtilization"
    - path: "src/components/debts/ProjectionTable.tsx"
      provides: "6-month payment projection table"
      contains: "ProjectionTable"
    - path: "src/App.tsx"
      provides: "Deudas NavLink and Route"
      contains: "DebtsPage"
  key_links:
    - from: "src/pages/DebtsPage.tsx"
      to: "src/stores/debtStore.ts"
      via: "useDebtStore for state and actions"
      pattern: "useDebtStore"
    - from: "src/components/debts/DebtDetail.tsx"
      to: "src/lib/tauri.ts"
      via: "debtApi.getDetail for loading installments on expand"
      pattern: "debtApi\\.getDetail"
    - from: "src/components/debts/InstallmentRow.tsx"
      to: "due_date comparison"
      via: "derive overdue status from due_date < today"
      pattern: "new Date"
    - from: "src/App.tsx"
      to: "src/pages/DebtsPage.tsx"
      via: "React Router Route element"
      pattern: "DebtsPage"
---

<objective>
Build the complete Debts page UI: expandable debt cards with installment detail, credit utilization summary, 6-month projection table, and route wiring.

Purpose: Deliver the user-facing debt management interface that ties together the backend data layer (Plan 01) and store/modals (Plan 02) into a cohesive page.
Output: DebtsPage with DebtCard accordion, DebtDetail with InstallmentRow, CreditUtilization summary, ProjectionTable, and navigation wiring.
</objective>

<execution_context>
@/home/jacket/.claude/get-shit-done/workflows/execute-plan.md
@/home/jacket/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-debts/04-RESEARCH.md
@.planning/phases/04-debts/04-CONTEXT.md
@.planning/phases/04-debts/04-01-SUMMARY.md
@.planning/phases/04-debts/04-02-SUMMARY.md

<interfaces>
<!-- From Plan 01: TypeScript types -->

```typescript
export interface Debt {
  id: string; accountId: string; description: string; originalAmount: number;
  totalInstallments: number; paidInstallments: number; monthlyPayment: number;
  interestRate: number; startDate: string; isActive: number; notes: string | null; createdAt: string;
}

export interface Installment {
  id: string; debtId: string; installmentNumber: number; dueDate: string;
  amount: number; status: "pending" | "paid"; actualPaymentDate: string | null;
  transactionId: string | null; createdAt: string;
}

export type InstallmentDisplayStatus = "pagado" | "pendiente" | "vencido";

export interface DebtWithInstallments {
  debt: Debt; installments: Installment[]; accountName: string;
  nextDueDate: string | null; remainingAmount: number;
}

export interface CreditUtilization {
  accountId: string; accountName: string; creditLimit: number;
  currentBalance: number; remainingDebtCommitments: number; availableCredit: number;
}

export interface MonthlyProjection {
  month: string; debts: DebtProjectionEntry[]; total: number;
}

export interface DebtProjectionEntry {
  debtId: string; debtDescription: string; amount: number;
}
```

<!-- From Plan 02: Store and modals -->

```typescript
export const useDebtStore = create<DebtState>(...);
// Actions: fetchDebts, setFilters, resetFilters, createDebt, updateDebt, deleteDebt,
//          getDebtDetail, markInstallmentPaid, fetchCreditUtilizations, fetchProjections

// Components available from Plan 02:
// DebtFormModal({ isOpen, onClose, editingDebt })
// MarkPaidModal({ isOpen, onClose, installment, debtDescription, onConfirm })
```

<!-- Existing patterns from codebase -->

From src/App.tsx (navigation pattern):

```typescript
const navLinks = [
  { to: "/accounts", label: "Cuentas" },
  { to: "/categories", label: "Categorias" },
  { to: "/transactions", label: "Transacciones" },
];
// ... NavLink rendering with isActive styling
// Routes: <Route path="/accounts" element={<AccountsPage />} />
```

From src/pages/TransactionsPage.tsx (page pattern):

```typescript
// useEffect to fetch on mount
// Modal state management (isOpen, editingItem)
// Toast/error display
// Conditional rendering based on loading/error/empty states
```

From src/lib/formatters.ts (amount formatting):

```typescript
export const formatMoney = (amount: number, currencyCode: string): string => { ... };
export const fromMinorUnits = (minorUnits: number, decimalPlaces: number): number => { ... };
```

</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: InstallmentRow component with status badges</name>
  <files>
    src/components/debts/InstallmentRow.tsx
  </files>
  <action>
    Create `src/components/debts/InstallmentRow.tsx`:

    **Props:** `installment: Installment`, `onMarkPaid: (installment: Installment) => void`.

    **Derive display status:**
    ```typescript
    const getDisplayStatus = (installment: Installment): InstallmentDisplayStatus => {
      if (installment.status === "paid") return "pagado";
      const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
      if (installment.dueDate < today) return "vencido";
      return "pendiente";
    };
    ```

    **Layout — single row:**
    - Left: Installment number ("Cuota {N}").
    - Center: Due date formatted (e.g., "15 Mar 2026"). If paid, show actual payment date below in smaller text.
    - Center-right: Amount formatted with formatMoney.
    - Right: Status badge:
      - "pagado" — green background (#1a3a0a), green text (#7fff00), border (#2a5518).
      - "pendiente" — neutral background (#1a1a0a), muted text (#6b7c3e), border (#2a3518).
      - "vencido" — red/warning background (#3a1a0a), red text (#ff4444), border (#552218).
    - Action: If status is "pendiente" or "vencido", show a small "Pagar" button that calls `onMarkPaid(installment)`.

    **Styling:** Consistent with the Lovecraftian dark theme. Share Tech Mono font. Row has subtle bottom border (#2a3518).
  </action>
  <verify>
    <automated>cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>InstallmentRow compiles. Derives display status from due_date vs today. Status badges with correct colors. Pagar button only on pending/overdue installments.</done>
</task>

<task type="auto">
  <name>Task 2: DebtDetail expanded view with installment list and progress bar</name>
  <files>
    src/components/debts/DebtDetail.tsx
  </files>
  <action>
    Create `src/components/debts/DebtDetail.tsx`:

    **Props:** `debtId: string`, `onMarkPaid: (installment: Installment) => void`.

    **State:** Uses `debtApi.getDetail(debtId)` to load full detail (DebtWithInstallments) when the component mounts. Loading state while fetching.

    **Layout:**
    - **Progress bar at top:** Visual bar showing paid/total installments.
      - Text: "{paidInstallments}/{totalInstallments} cuotas pagadas"
      - Bar: filled portion = (paidInstallments / totalInstallments) * 100%.
      - Filled color: #4a5d23 (moss green). Background: #1a1a0a.
      - Border: 1px solid #2a3518. Height: 8px. Border-radius: 4px.

    - **Summary stats row:** Remaining amount | Next due date (or "Completada" if all paid).

    - **Installment list:** Scrollable container (max-height ~300px, overflow-y auto).
      - Map over installments, render `<InstallmentRow>` for each.
      - Ordered by installment_number ascending (already sorted from backend).

    **Loading state:** Show "Cargando cuotas..." with muted text while fetching detail.

    **Error state:** Show error message if fetch fails.

    **Refetch:** Expose a `refetch` method or use a key prop pattern so the parent can trigger a refresh after marking an installment as paid.
  </action>
  <verify>
    <automated>cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>DebtDetail compiles. Fetches full detail on mount. Progress bar shows paid/total. Scrollable installment list renders InstallmentRow for each installment. Loading and error states handled.</done>
</task>

<task type="auto">
  <name>Task 3: DebtCard expandable accordion component</name>
  <files>
    src/components/debts/DebtCard.tsx
  </files>
  <action>
    Create `src/components/debts/DebtCard.tsx`:

    **Props:** `debt: Debt`, `isExpanded: boolean`, `onToggle: () => void`, `onEdit: (debt: Debt) => void`, `onDelete: (debt: Debt) => void`, `onMarkPaid: (installment: Installment) => void`, `accountName: string`, `currencyCode: string`.

    Note: `accountName` and `currencyCode` are passed from the parent which resolves them from the account store.

    **Collapsed state (always visible):**
    Card with padding, dark background (#111a0a), border (#2a3518), border-radius.

    Row layout:
    - **Left column:**
      - Description (bold, #c5d4a0 text, Cinzel or Share Tech Mono).
      - Account name (smaller, muted #6b7c3e).
    - **Center:**
      - Mini progress bar (thin, inline, same colors as DebtDetail progress bar).
      - Text: "{paidInstallments}/{totalInstallments}" below the bar.
    - **Right column:**
      - Remaining amount: `formatMoney(originalAmount - (paidInstallments * monthlyPayment), currencyCode)` — or better, show the computed remaining from (totalInstallments - paidInstallments) * monthlyPayment.
      - Monthly payment: "Cuota: {formatMoney(monthlyPayment, currencyCode)}".
      - Interest rate: "{interestRate}%" (if > 0).
      - Next due date (computed or "Completada").
    - **Far right:**
      - Expand/collapse chevron icon (ChevronDown/ChevronUp from lucide-react).
      - Small edit and delete icon buttons (Pencil, Trash2 from lucide-react), visible on hover or always.

    **Expanded state:**
    Below the collapsed summary, render `<DebtDetail debtId={debt.id} onMarkPaid={onMarkPaid} />`.
    Add a subtle top border (#2a3518) between summary and detail.

    **Click behavior:** Clicking anywhere on the card header toggles expand/collapse. Edit and delete buttons stop propagation to avoid toggling.

    **Styling:** Lovecraftian dark theme. Hover effect on card (subtle border color change to #4a5d23). Transition on expand/collapse.
  </action>
  <verify>
    <automated>cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>DebtCard compiles. Collapsed summary shows all required info (description, account, progress, remaining, monthly, rate, next due). Expanded state renders DebtDetail. Click toggles expand. Edit/delete buttons with stopPropagation.</done>
</task>

<task type="auto">
  <name>Task 4: CreditUtilization summary component</name>
  <files>
    src/components/debts/CreditUtilization.tsx
  </files>
  <action>
    Create `src/components/debts/CreditUtilization.tsx`:

    **Props:** `utilizations: CreditUtilization[]`, `currencyCode: string`.

    **Layout:**
    Section with header: "Utilizacion de Credito" (Cinzel Decorative or styled header).

    If empty (no credit card accounts with credit limits): show nothing or a subtle message "Sin tarjetas de credito configuradas".

    For each credit card account:
    - Card/row with account name.
    - **Visual bar:** Shows utilization percentage (currentBalance / creditLimit * 100).
      - Fill color: gradient from #4a5d23 (low) to #ff4444 (high, > 80%).
      - Background: #1a1a0a. Border: #2a3518.
    - **Stats row:**
      - "Saldo actual: {formatMoney(currentBalance)}" — what's currently owed.
      - "Compromisos pendientes: {formatMoney(remainingDebtCommitments)}" — sum of future installments.
      - "Limite: {formatMoney(creditLimit)}".
      - "Disponible: {formatMoney(availableCredit)}".

    **Styling:** Dark card background (#111a0a), consistent with other components. Numbers in JetBrains Mono.
  </action>
  <verify>
    <automated>cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>CreditUtilization compiles. Shows per-account utilization bars with balance, commitments, limit, and available credit. Color-coded bar based on utilization percentage. Hidden when no credit card accounts exist.</done>
</task>

<task type="auto">
  <name>Task 5: ProjectionTable 6-month lookahead component</name>
  <files>
    src/components/debts/ProjectionTable.tsx
  </files>
  <action>
    Create `src/components/debts/ProjectionTable.tsx`:

    **Props:** `projections: MonthlyProjection[]`, `currencyCode: string`.

    **Layout:**
    Section with header: "Proyeccion de Pagos (6 meses)".

    If empty (no pending installments in next 6 months): show "Sin pagos programados en los proximos 6 meses."

    **Table structure:**
    - Rows = months (YYYY-MM formatted nicely, e.g., "Mar 2026", "Abr 2026").
    - Columns = unique debts across all months + "Total" column.
    - Extract unique debt IDs from all projections to build column headers.
    - Column headers: debt descriptions (truncated if long). Last column: "Total".
    - Cell values: formatted amounts. Empty cell if a debt has no installment that month.
    - Total column: sum for that month.

    **Styling:**
    - Dark table: background #111a0a, header #0a0f06, borders #2a3518.
    - Numbers: JetBrains Mono font, right-aligned.
    - Header text: Share Tech Mono, #6b7c3e.
    - Total column: slightly brighter text (#7fff00).
    - Horizontal scroll if many debt columns (overflow-x: auto on container).

    **Month formatting:** Convert "2026-03" to "Mar 2026" for display. Use a simple mapping or Date parsing.
  </action>
  <verify>
    <automated>cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>ProjectionTable compiles. Renders month rows with per-debt columns and total. Dynamic column generation from unique debts. Formatted month names. Horizontal scroll for many debts. Empty state message when no projections.</done>
</task>

<task type="auto">
  <name>Task 6: DebtsPage composing all components with route wiring</name>
  <files>
    src/pages/DebtsPage.tsx
    src/App.tsx
  </files>
  <action>
    **Create src/pages/DebtsPage.tsx:**

    Main page component following the TransactionsPage/CategoriesPage pattern.

    **State management:**
    - `const { debts, isLoading, error, filters, fetchDebts, setFilters, createDebt, deleteDebt, creditUtilizations, fetchCreditUtilizations, projections, fetchProjections } = useDebtStore();`
    - `const { accounts } = useAccountStore();` — for resolving account names and currency codes.
    - `const { categories } = useCategoryStore();` — for MarkPaidModal category list.
    - Local state: `expandedDebtId: string | null` (which card is expanded), `isFormOpen: boolean`, `editingDebt: Debt | null`, `markPaidInstallment: Installment | null`, `markPaidDebtDescription: string`.

    **useEffect on mount:** fetch debts, credit utilizations, projections, accounts, categories.

    **Page layout (top to bottom):**

    1. **Page header:** "Deudas" title + "Nueva Deuda" button (+ icon).

    2. **Credit utilization section** (only if creditUtilizations has items):
       `<CreditUtilization utilizations={creditUtilizations} currencyCode="CLP" />`
       Place this at the top of the page, above the debt list.

    3. **Debt list:** Map over `debts` array. For each debt:
       - Resolve account name from accounts array.
       - Resolve currency code from accounts + currencies.
       - Render `<DebtCard>` with expand/collapse toggled by `expandedDebtId`.
       - Pass onEdit, onDelete, onMarkPaid handlers.

    4. **Projection table** (below debt list):
       `<ProjectionTable projections={projections} currencyCode="CLP" />`
       Place below the debt cards.

    **Empty state:** If no debts, show centered message: "No hay deudas registradas" with a "Crear Primera Deuda" button.

    **Loading state:** Show loading indicator while `isLoading` is true.

    **Error state:** Show error message if `error` is set.

    **Modal handlers:**
    - "Nueva Deuda" button -> open DebtFormModal in create mode.
    - Edit button on DebtCard -> open DebtFormModal in edit mode.
    - Delete button on DebtCard -> window.confirm("Eliminar esta deuda y todas sus cuotas?") then debtStore.deleteDebt(id).
    - "Pagar" button on InstallmentRow -> open MarkPaidModal with that installment.
    - After MarkPaidModal confirms: refetch debts, credit utilizations, projections. Collapse and re-expand the debt card to refresh installment list.

    **Modals rendered at bottom of page:**
    - `<DebtFormModal isOpen={isFormOpen} onClose={handleCloseForm} editingDebt={editingDebt} />`
    - `<MarkPaidModal isOpen={markPaidInstallment !== null} onClose={handleCloseMarkPaid} installment={markPaidInstallment} debtDescription={markPaidDebtDescription} onConfirm={handleMarkPaid} />`

    **In App.tsx:**
    1. Import DebtsPage: `import { DebtsPage } from "./pages/DebtsPage";`
    2. Add to navLinks array: `{ to: "/debts", label: "Deudas" }` (after Transacciones).
    3. Add Route: `<Route path="/debts" element={<DebtsPage />} />`.
  </action>
  <verify>
    <automated>cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>DebtsPage compiles and renders all sections: credit utilization, debt cards, projection table. DebtFormModal and MarkPaidModal wired. App.tsx has "Deudas" nav link and /debts route. All handlers connected.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 7: Visual verification of Debts page</name>
  <action>
    Run the application: `cd /home/jacket/PROYECTOS/PERSONALES/Necronomics && npm run tauri dev`

    Verify the following:
    1. Navigate to "Deudas" in the navigation bar.
    2. Create a new debt via the "Nueva Deuda" button:
       - Select an account (try a credit card account if one exists).
       - Fill in: description, amount, installments (e.g., 12), monthly payment, interest rate, start date.
       - Submit and verify the debt appears in the list.
    3. Verify the debt card shows: description, account name, progress bar (0/12), remaining amount, monthly payment, interest rate, next due date.
    4. Click the debt card to expand it.
    5. Verify the expanded view shows: progress bar, installment list with status badges.
    6. Verify installments that are past their due date show "vencido" (red) badge.
    7. Click "Pagar" on a pending installment.
    8. Verify the MarkPaidModal appears with category picker.
    9. Select a category and confirm payment.
    10. Verify the installment now shows "pagado" (green) and the progress bar updates.
    11. If a credit-card account has debts, verify the credit utilization section shows at the top.
    12. Verify the projection table shows upcoming months with amounts.
  </action>
  <done>Debts page renders correctly with all components. Debt CRUD works. Installment tracking works with status badges. Mark-as-paid flow creates transactions and updates installment status. Credit utilization displays for credit card accounts. Projection table shows 6-month lookahead.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — All TypeScript files compile
2. `cargo check` — Rust still compiles (no regression)
3. App.tsx has "Deudas" in navLinks and /debts route
4. DebtsPage renders debt cards, credit utilization, and projection table
5. InstallmentRow derives overdue status from due_date < today (no backend dependency for overdue)
6. DebtCard expand/collapse works with single-card-expanded pattern
7. MarkPaidModal flow: select category -> confirm -> installment marked as paid -> transaction created
</verification>

<success_criteria>

- Navigation includes "Deudas" link routing to DebtsPage
- Debt cards show collapsed summary with all required fields
- Expanding a card reveals installment list with progress bar
- Installment status badges (pagado/pendiente/vencido) render correctly with vencido derived from date
- Mark-as-paid opens category picker modal and creates expense transaction on confirm
- Credit utilization section visible for credit-card accounts
- 6-month projection table renders with per-debt columns and total
- All components use consistent Lovecraftian dark theme styling

</success_criteria>

<output>
After completion, create `.planning/phases/04-debts/04-03-SUMMARY.md`
</output>
