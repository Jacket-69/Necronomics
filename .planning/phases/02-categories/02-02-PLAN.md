---
phase: 02-categories
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - package.json
  - src/stores/categoryStore.ts
  - src/pages/CategoriesPage.tsx
  - src/components/categories/CategoryList.tsx
  - src/components/categories/CategoryGroup.tsx
  - src/components/categories/CategoryRow.tsx
  - src/components/categories/ContextMenu.tsx
  - src/App.tsx
autonomous: true
requirements: [CATE-01, CATE-02, CATE-03]

must_haves:
  truths:
    - "User can view categories in tabbed income/expense layout"
    - "Parent categories are shown with subcategories indented underneath"
    - "Each category row shows Lucide icon, name, subcategory count, and placeholder transaction columns"
    - "Right-click opens context menu with Editar, Eliminar, Agregar subcategoria"
    - "Nueva categoria button is visible and navigable"
    - "Empty state shows when no categories exist for a tab"
    - "Sort dropdown allows alphabetical sorting per tab"
  artifacts:
    - path: "src/stores/categoryStore.ts"
      provides: "Zustand category store with async CRUD actions"
      min_lines: 50
    - path: "src/pages/CategoriesPage.tsx"
      provides: "Categories page with tabbed layout and toast notifications"
      min_lines: 40
    - path: "src/components/categories/CategoryList.tsx"
      provides: "Category list grouped by parent with sort control"
      min_lines: 40
    - path: "src/components/categories/CategoryRow.tsx"
      provides: "Individual category row with icon, name, stats columns"
    - path: "src/components/categories/ContextMenu.tsx"
      provides: "Right-click context menu component"
  key_links:
    - from: "src/stores/categoryStore.ts"
      to: "src/lib/tauri.ts"
      via: "categoryApi calls"
      pattern: "categoryApi\\.(list|create|update|delete)"
    - from: "src/pages/CategoriesPage.tsx"
      to: "src/stores/categoryStore.ts"
      via: "useCategoryStore hook"
      pattern: "useCategoryStore"
    - from: "src/App.tsx"
      to: "src/pages/CategoriesPage.tsx"
      via: "React Router route"
      pattern: "path.*categories"
---

<objective>
Build the Zustand category store, the categories list page with tabbed income/expense layout, grouped parent/subcategory hierarchy, context menu, sort dropdown, and empty states.

Purpose: Deliver the main category browsing UI following the exact Phase 1 patterns (store, page, list components).
Output: Functional category listing with tabs, hierarchy grouping, context menu, and route wired in App.tsx.
</objective>

<execution_context>
@/home/jacket/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/jacket/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-categories/02-CONTEXT.md
@.planning/phases/02-categories/02-01-SUMMARY.md

<interfaces>
<!-- Types and API from Plan 01 (will exist when this plan runs) -->

From src/types/index.ts:

```typescript
export type CategoryType = "income" | "expense";

export interface Category {
  id: string;
  name: string;
  type: CategoryType;
  icon: string | null;
  parentId: string | null;
  isActive: number;
  createdAt: string;
}

export interface CreateCategoryInput {
  name: string;
  categoryType: CategoryType;
  icon: string | null;
  parentId: string | null;
}

export interface UpdateCategoryInput {
  name?: string;
  categoryType?: CategoryType;
  icon?: string | null;
  parentId?: string | null;
}
```

From src/lib/tauri.ts:

```typescript
export const categoryApi = {
  list: (): Promise<Category[]> => invoke("list_categories"),
  get: (id: string): Promise<Category> => invoke("get_category", { id }),
  create: (input: CreateCategoryInput): Promise<Category> => invoke("create_category", { ... }),
  update: (id: string, input: UpdateCategoryInput): Promise<Category> => invoke("update_category", { id, ... }),
  delete: (id: string): Promise<void> => invoke("delete_category", { id }),
};
```

From src/stores/accountStore.ts (pattern to follow):

```typescript
export const useAccountStore = create<AccountState>((set, get) => ({
  accounts: [],
  isLoading: false,
  error: null,
  fetchAccounts: async () => {
    set({ isLoading: true, error: null });
    try {
      const accounts = await accountApi.list();
      set({ accounts, isLoading: false });
    } catch (e) {
      set({ error: String(e), isLoading: false });
    }
  },
  // ... CRUD actions with error recovery via refetch
}));
```

From src/pages/AccountsPage.tsx (pattern to follow):

- useEffect fetch on mount
- Loading/error/empty states
- Toast pattern: useState + useEffect setTimeout

From src/App.tsx:

```typescript
import { Routes, Route, Navigate } from "react-router";
// Add /categories route here
```

</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install lucide-react and create Zustand category store</name>
  <files>
    package.json
    src/stores/categoryStore.ts
  </files>
  <action>
    **1. Install lucide-react:**
    ```bash
    npm install lucide-react
    ```

    **2. Create src/stores/categoryStore.ts** following the exact accountStore pattern:

    State interface:
    ```typescript
    interface CategoryState {
      categories: Category[];
      isLoading: boolean;
      error: string | null;
      fetchCategories: () => Promise<void>;
      addCategory: (input: CreateCategoryInput) => Promise<Category>;
      updateCategory: (id: string, input: UpdateCategoryInput) => Promise<Category>;
      deleteCategory: (id: string) => Promise<void>;
    }
    ```

    Implementation:
    - `fetchCategories` — calls `categoryApi.list()`, sets categories, handles loading/error states
    - `addCategory` — calls `categoryApi.create(input)`, appends to state, error recovery via refetch
    - `updateCategory` — calls `categoryApi.update(id, input)`, replaces in state by id, error recovery via refetch
    - `deleteCategory` — calls `categoryApi.delete(id)`, removes from state by id AND removes any subcategories with matching parentId, error recovery via refetch

    Follow the EXACT same pattern as accountStore.ts: try/catch, optimistic update, catch refetch.

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>lucide-react installed, categoryStore compiles, exports useCategoryStore with fetchCategories, addCategory, updateCategory, deleteCategory</done>
</task>

<task type="auto">
  <name>Task 2: Build category list page with tabs, hierarchy, context menu, and routing</name>
  <files>
    src/pages/CategoriesPage.tsx
    src/components/categories/CategoryList.tsx
    src/components/categories/CategoryGroup.tsx
    src/components/categories/CategoryRow.tsx
    src/components/categories/ContextMenu.tsx
    src/App.tsx
  </files>
  <action>
    **1. Create src/components/categories/ContextMenu.tsx:**
    - Generic right-click context menu component.
    - Props: `items: Array<{ label: string; onClick: () => void; disabled?: boolean }>`, `position: { x: number; y: number }`, `onClose: () => void`.
    - Renders a positioned `div` (position: fixed) at the click coordinates with menu items.
    - Closes on click outside (useEffect with document click listener) or Escape key.
    - Styled with dark theme: `bg-[#1a1f14]` border `border-[#4a5d23]`, text `text-[#c4cfb4]`, hover `bg-[#2a3320]`.

    **2. Create src/components/categories/CategoryRow.tsx:**
    - Props: `category: Category`, `subcategoryCount: number`, `isSubcategory: boolean`, `onContextMenu: (e: React.MouseEvent, category: Category) => void`.
    - Renders a table row with columns:
      - Icon column: Lucide icon rendered dynamically from `category.icon` string. Use `lucide-react` dynamic import pattern: import the icons object and look up by name. If icon is null or not found, use a default (e.g., `Circle`). Color the icon: green-tinted (`text-[#7a9f35]`) for income, red/blood-tinted (`text-[#9f3535]`) for expense.
      - Name column: category name, indented for subcategories (use `pl-8` for subcategories, `pl-2` for parents). Parent names slightly bolder (`font-medium`).
      - Subcategory count column: show count for parents only, dash for subcategories.
      - Transaction count column: show "0" (placeholder for Phase 3), styled muted.
      - Total amount column: show "-" (placeholder for Phase 3), styled muted.
    - Attach `onContextMenu` handler to the row for right-click.

    **Dynamic icon rendering approach:** Import specific icons from lucide-react into an icon map object (do NOT use dynamic imports — use a static map of ~35 icons). Example:
    ```typescript
    import { Utensils, ShoppingCart, /* ... */ } from "lucide-react";
    const iconMap: Record<string, React.ComponentType<{ size?: number; className?: string }>> = {
      "utensils": Utensils,
      "shopping-cart": ShoppingCart,
      // ... all icons used by seed data + extras for user selection
    };
    ```
    Export this iconMap for reuse in the icon picker (Plan 03).

    **3. Create src/components/categories/CategoryGroup.tsx:**
    - Props: `parent: Category`, `subcategories: Category[]`, `onContextMenu: (e: React.MouseEvent, category: Category) => void`.
    - Renders: parent CategoryRow, then each subcategory as indented CategoryRow.
    - Subcategory count is computed from subcategories.length.

    **4. Create src/components/categories/CategoryList.tsx:**
    - Props: `categories: Category[]`, `activeTab: CategoryType`, `sortOrder: string`, `onContextMenu: (e: React.MouseEvent, category: Category) => void`.
    - Groups categories by parent: extract parents (parentId === null), for each parent find its subcategories (parentId === parent.id).
    - Also handle orphan subcategories gracefully (shouldn't happen but defensive).
    - Sort parents alphabetically (A-Z) by name. Sort subcategories alphabetically within each parent.
    - Filter by activeTab type.
    - Renders table with column headers: "", "Nombre", "Subcategorias", "Transacciones", "Total".
    - If no categories for this tab: show empty state with themed message. For income: "No hay categorias de ingreso". For expense: "No hay categorias de gasto". Show a prominent "+ Nueva categoria" button in the empty state.
    - Sort dropdown in top-right: only "Alfabetico A-Z" option for Phase 2 (dropdown still rendered for future options).

    **5. Create src/pages/CategoriesPage.tsx:**
    - Uses `useCategoryStore` — fetchCategories on mount (useEffect pattern from AccountsPage).
    - State: `activeTab: CategoryType` (default "expense"), `sortOrder` per tab (stored as `{ income: string, expense: string }`), `contextMenu` state (position + category), `toast` state.
    - Tab bar: two tabs "Gastos" and "Ingresos" — styled tabs with active indicator. Gastos tab active by default.
    - Renders CategoryList for the active tab.
    - Context menu handler: sets position and target category. Menu items:
      - "Editar" — triggers edit flow (sets editingCategory state, will open modal from Plan 03)
      - "Eliminar" — triggers delete flow (sets deletingCategory state, will open modal from Plan 03)
      - "Agregar subcategoria" — only shown for parent categories. Triggers add-subcategory flow (sets addSubcategoryParent state, will open modal from Plan 03)
    - Top bar: page title "Categorias" + "+ Nueva categoria" button.
    - For Phase 2: the context menu triggers store state for editing/deleting/adding. Expose these as state so Plan 03 can wire modals. For now, the edit/delete/add actions should use `console.log` placeholders with a TODO comment mentioning Plan 03 will wire the modals.
    - Loading, error states following AccountsPage pattern.
    - Toast notification following AccountsPage pattern (useState + useEffect setTimeout with cleanup, 3 second auto-dismiss).

    **6. Wire route in src/App.tsx:**
    - Import CategoriesPage.
    - Add route: `<Route path="/categories" element={<CategoriesPage />} />`.
    - Keep existing account routes intact.

    **Styling notes (from CONTEXT.md and existing patterns):**
    - Dark theme colors: bg `#0a0f06`, borders `#4a5d23`, text `#c4cfb4`, hover `#2a3320`
    - Match the overall aesthetic established in AccountsPage
    - Spanish UI labels throughout

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>Category list page renders with tabbed layout, grouped parent/subcategory hierarchy, context menu on right-click, sort dropdown, empty states, and /categories route wired in App.tsx. Lucide icons render for each category.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- /categories route exists in App.tsx
- CategoryList groups categories by parent with subcategories indented
- Lucide icons render from icon name strings
- Context menu appears on right-click with correct items
- Empty state shows for tabs with no categories
- Tab switching works between Gastos/Ingresos
</verification>

<success_criteria>

- lucide-react installed and icon map created
- Zustand store follows accountStore pattern exactly
- Categories page with tabs, grouped hierarchy, context menu renders without errors
- Route wired in App.tsx
- All Spanish UI labels
  </success_criteria>

<output>
After completion, create `.planning/phases/02-categories/02-02-SUMMARY.md`
</output>
