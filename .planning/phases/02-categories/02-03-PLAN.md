---
phase: 02-categories
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/components/categories/IconPicker.tsx
  - src/components/categories/CategoryFormModal.tsx
  - src/components/categories/DeleteCategoryModal.tsx
  - src/pages/CategoriesPage.tsx
autonomous: true
requirements: [CATE-01, CATE-02, CATE-03, CATE-04]

must_haves:
  truths:
    - "User can create a parent category via modal form with name, type, and icon"
    - "User can create a subcategory via modal with parent pre-filled and locked"
    - "User can edit category name, type, icon, and parent assignment"
    - "Type change cascades to subcategories (handled by backend)"
    - "Type change blocked if transactions exist (error shown from backend)"
    - "Deletion blocked with message when linked transactions exist"
    - "Parent deletion shows cascade warning and deletes subcategories"
    - "Unsaved changes prompt confirmation before modal close"
    - "Successful CRUD shows toast notification"
    - "Icon picker shows curated Lucide icon grid"
  artifacts:
    - path: "src/components/categories/IconPicker.tsx"
      provides: "Curated Lucide icon grid picker"
      min_lines: 30
    - path: "src/components/categories/CategoryFormModal.tsx"
      provides: "Create/edit category modal with validation"
      min_lines: 80
    - path: "src/components/categories/DeleteCategoryModal.tsx"
      provides: "Delete confirmation modal with transaction guard"
      min_lines: 40
    - path: "src/pages/CategoriesPage.tsx"
      provides: "Updated page wiring modals to context menu actions"
  key_links:
    - from: "src/components/categories/CategoryFormModal.tsx"
      to: "src/stores/categoryStore.ts"
      via: "addCategory and updateCategory calls"
      pattern: "(addCategory|updateCategory)"
    - from: "src/components/categories/DeleteCategoryModal.tsx"
      to: "src/stores/categoryStore.ts"
      via: "deleteCategory call"
      pattern: "deleteCategory"
    - from: "src/pages/CategoriesPage.tsx"
      to: "src/components/categories/CategoryFormModal.tsx"
      via: "state-driven modal rendering"
      pattern: "CategoryFormModal"
    - from: "src/pages/CategoriesPage.tsx"
      to: "src/components/categories/DeleteCategoryModal.tsx"
      via: "state-driven modal rendering"
      pattern: "DeleteCategoryModal"
---

<objective>
Build the category form modal (create/edit), icon picker, and delete confirmation modal. Wire all modals to the context menu actions and the "+ Nueva categoria" button in CategoriesPage.

Purpose: Complete the category CRUD UI flows — create, edit, delete with all business rules from CONTEXT.md.
Output: Fully functional category management with form validation, icon selection, cascade warnings, and transaction-link guards.
</objective>

<execution_context>
@/home/jacket/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/jacket/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-categories/02-CONTEXT.md
@.planning/phases/02-categories/02-02-SUMMARY.md

<interfaces>
<!-- From Plan 02 — will exist when this runs -->

From src/stores/categoryStore.ts:

```typescript
interface CategoryState {
  categories: Category[];
  isLoading: boolean;
  error: string | null;
  fetchCategories: () => Promise<void>;
  addCategory: (input: CreateCategoryInput) => Promise<Category>;
  updateCategory: (id: string, input: UpdateCategoryInput) => Promise<Category>;
  deleteCategory: (id: string) => Promise<void>;
}
export const useCategoryStore = create<CategoryState>(...);
```

From src/types/index.ts:

```typescript
export type CategoryType = "income" | "expense";
export interface Category {
  id: string;
  name: string;
  type: CategoryType;
  icon: string | null;
  parentId: string | null;
  isActive: number;
  createdAt: string;
}
export interface CreateCategoryInput {
  name: string;
  categoryType: CategoryType;
  icon: string | null;
  parentId: string | null;
}
export interface UpdateCategoryInput {
  name?: string;
  categoryType?: CategoryType;
  icon?: string | null;
  parentId?: string | null;
}
```

From src/components/categories/CategoryRow.tsx:

```typescript
// iconMap exported for reuse
export const iconMap: Record<string, React.ComponentType<{ size?: number; className?: string }>> = { ... };
```

From src/components/accounts/AccountForm.tsx (pattern to follow):

- react-hook-form + zodResolver pattern
- Zod v4 validation with z.enum({ message: "..." }) pattern
- onBlur validation mode
- Spanish error messages

From src/components/accounts/ConfirmDeleteModal.tsx (pattern to follow):

- Overlay + centered modal box
- Clear confirmation messaging
- Action buttons at bottom
  </interfaces>
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create icon picker and category form modal</name>
  <files>
    src/components/categories/IconPicker.tsx
    src/components/categories/CategoryFormModal.tsx
  </files>
  <action>
    **1. Create src/components/categories/IconPicker.tsx:**
    - Props: `selectedIcon: string | null`, `onSelect: (iconName: string) => void`, `categoryType: CategoryType`.
    - Renders a grid (~5 columns) of curated Lucide icons from the `iconMap` exported by CategoryRow.tsx.
    - Each icon is a clickable button showing the icon with its name below.
    - Selected icon has a highlighted border (`border-[#7a9f35]` for income, `border-[#9f3535]` for expense).
    - Icons colored by category type: green-tinted for income, red/blood-tinted for expense.
    - Grid scrollable if more than ~20 icons visible (max-height with overflow-y-auto).

    **2. Create src/components/categories/CategoryFormModal.tsx:**
    - Props:
      - `isOpen: boolean`
      - `onClose: () => void`
      - `onSuccess: (message: string) => void` — called with toast message on successful save
      - `editCategory?: Category` — if provided, form is in edit mode with pre-populated values
      - `parentCategory?: Category` — if provided, form is in "add subcategory" mode with parent locked
      - `categories: Category[]` — all categories for parent dropdown

    - Uses react-hook-form + zodResolver (same pattern as AccountForm).

    - **Zod schema:**
      ```typescript
      const categorySchema = z.object({
        name: z.string().min(1, "El nombre es requerido").max(50, "Maximo 50 caracteres"),
        categoryType: z.enum(["income", "expense"], { message: "Selecciona un tipo" }),
        icon: z.string().nullable(),
        parentId: z.string().nullable(),
      });
      ```

    - **Form fields:**
      1. **Nombre** — text input, required. Inline validation: check for duplicate names (same name + same parentId + same type → "Este nombre ya existe").
      2. **Tipo** — radio buttons: "Ingreso" / "Gasto". In "add subcategory" mode: type is inherited from parent, radio disabled. In edit mode: type change is allowed (backend handles cascade/blocking). Show warning text when changing type in edit mode: "Cambiar el tipo tambien cambiara el tipo de todas las subcategorias."
      3. **Icono** — IconPicker component. Default: null (backend/UI handles null gracefully). Subcategories inherit parent icon by default but can override.
      4. **Categoria padre** — dropdown select. Only shown when NOT in "add subcategory" mode (where it's pre-filled and locked). Lists only parent categories (parentId === null) of the SAME TYPE as selected categoryType. If categoryType changes, filter parent options. In edit mode: if category has subcategories, parent field is disabled (cannot demote parent to subcategory). Set to null for parent categories.

    - **Modal UI:**
      - Overlay (click outside → check dirty, confirm discard if dirty)
      - Escape key → same close logic
      - Title: "Nueva categoria" / "Editar categoria" / "Nueva subcategoria de {parentName}"
      - Form body with fields
      - Footer: "Cancelar" and "Guardar" buttons. Guardar disabled while submitting.
      - Dirty state tracking: if form is dirty and user tries to close, show "Descartar cambios?" confirmation (simple window.confirm or inline prompt).

    - **Submit handler:**
      - Create mode: calls `addCategory(input)` from store, then `onSuccess("Categoria creada")`
      - Edit mode: calls `updateCategory(id, input)` from store, then `onSuccess("Categoria actualizada")`
      - Error handling: catch errors from backend (e.g., type change blocked), display as form-level error message below form.

    - **Styling:** Dark theme matching existing modals. Background `#0a0f06`, border `#4a5d23`, text `#c4cfb4`. Form inputs with dark backgrounds.

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>IconPicker renders curated Lucide icon grid with type-based coloring. CategoryFormModal handles create, edit, and add-subcategory modes with Zod validation, parent dropdown, icon picker, and dirty-state discard confirmation.</done>
</task>

<task type="auto">
  <name>Task 2: Create delete modal and wire all modals to CategoriesPage</name>
  <files>
    src/components/categories/DeleteCategoryModal.tsx
    src/pages/CategoriesPage.tsx
  </files>
  <action>
    **1. Create src/components/categories/DeleteCategoryModal.tsx:**
    - Props:
      - `isOpen: boolean`
      - `category: Category | null` — the category to delete
      - `subcategories: Category[]` — subcategories of this category (empty array if none)
      - `onClose: () => void`
      - `onSuccess: (message: string) => void`

    - **Modal content based on context:**
      - **Category with no subcategories:** Simple confirmation. "Estas seguro de que quieres eliminar la categoria '{name}'?" with "Cancelar" and "Eliminar" buttons. Eliminar button red-tinted.
      - **Parent with subcategories:** Cascade warning. "Eliminar '{name}' tambien eliminara las siguientes subcategorias:" followed by a list of subcategory names. "Cancelar" and "Eliminar todo" buttons.
      - **Error state:** If backend returns error (e.g., transaction link), display the error message prominently. The error message from backend already includes guidance ("Reasigna las transacciones..."). Show "Entendido" button to close.

    - **Delete handler:**
      - Calls `deleteCategory(category.id)` from store.
      - On success: `onSuccess("Categoria eliminada")` and close.
      - On error: set error state and display backend error message.

    - **Styling:** Same modal pattern as ConfirmDeleteModal from accounts (overlay + centered box). Red-tinted delete button.

    **2. Update src/pages/CategoriesPage.tsx to wire all modals:**

    Replace the console.log placeholders from Plan 02 with actual modal state and rendering.

    - **State additions:**
      - `formModal: { isOpen: boolean; editCategory?: Category; parentCategory?: Category }` — controls CategoryFormModal
      - `deleteModal: { isOpen: boolean; category: Category | null }` — controls DeleteCategoryModal

    - **"+ Nueva categoria" button:** Opens form modal in create mode: `setFormModal({ isOpen: true })`

    - **Context menu handlers:**
      - "Editar" → `setFormModal({ isOpen: true, editCategory: category })`
      - "Eliminar" → `setDeleteModal({ isOpen: true, category })`
      - "Agregar subcategoria" → `setFormModal({ isOpen: true, parentCategory: category })`

    - **Modal rendering (below the page content):**
      ```tsx
      <CategoryFormModal
        isOpen={formModal.isOpen}
        onClose={() => setFormModal({ isOpen: false })}
        onSuccess={(msg) => { setToast(msg); setFormModal({ isOpen: false }); }}
        editCategory={formModal.editCategory}
        parentCategory={formModal.parentCategory}
        categories={categories}
      />
      <DeleteCategoryModal
        isOpen={deleteModal.isOpen}
        category={deleteModal.category}
        subcategories={categories.filter(c => c.parentId === deleteModal.category?.id)}
        onClose={() => setDeleteModal({ isOpen: false, category: null })}
        onSuccess={(msg) => { setToast(msg); setDeleteModal({ isOpen: false, category: null }); }}
      />
      ```

    - **On modal success:** show toast, modal auto-closes, list refreshes from store (store actions already update state).

    - Ensure context menu closes when a modal opens.

  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>DeleteCategoryModal shows appropriate confirmation (simple or cascade warning) and blocks on transaction links. All modals wired to CategoriesPage: "+ Nueva categoria" opens create modal, context menu opens edit/delete/add-subcategory modals. Toast notifications display on successful operations. Complete category CRUD lifecycle functional.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Create modal: opens from button, validates name/type, picks icon, saves via store
- Edit modal: pre-populates from category, allows type/name/icon/parent changes
- Add subcategory: parent pre-filled and locked, type inherited
- Delete modal: shows cascade warning for parents, blocks on transaction links
- Toast shows on success, modals close properly
- Dirty state confirmation works on modal close
</verification>

<success_criteria>

- All four CATE requirements (CATE-01 through CATE-04) fully functional in UI
- Category create/edit/delete lifecycle complete
- Icon picker with curated Lucide icons
- Transaction-link deletion guard shows backend error message
- Parent cascade delete shows warning with subcategory list
- Spanish UI labels throughout
- Matches the dark theme established in Phase 1
  </success_criteria>

<output>
After completion, create `.planning/phases/02-categories/02-03-SUMMARY.md`
</output>
